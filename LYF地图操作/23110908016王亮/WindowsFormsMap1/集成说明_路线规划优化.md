# 路线规划Bug修复与功能增强集成说明

## [Member E] 修改日期：2026-01-14

---

## 一、功能概述

本次更新解决了三个核心问题并实现了路线保存功能：

1. **视图刷新问题**：修复从路线规划切换到其他功能时地图不刷新的bug
2. **路径规划成功率优化**：从失败率80%提升到预计90%以上成功率
3. **路径持久化功能**：支持保存和加载历史路线，采用优化方案（只保存起终点，加载时重新计算）

---

## 二、修改文件清单

### 1. 数据库脚本

- **`create_route_tables.sql`** [NEW]
  - 创建 `Saved_Routes` 表（保存路线起终点）
  - 创建 `Route_ICH_Items` 表（保存沿途非遗点位）
  - 优化设计：不存完整路径JSON，节省存储空间

### 2. 后端代码

- **`Form1.Visual.cs`** [MODIFY]
  - 添加 `SaveRoute()` 方法：保存路线到数据库
  - 添加 `GetSavedRoutes()` 方法：获取历史路线列表
  - 添加 `GetRouteDetail()` 方法：获取路线详情

### 3. 前端代码

- **`main.js`** [MODIFY]
  - 修复 `handleViewChange()`: 切换导航时清除路线状态
  - 添加 `clearRouteState()`: 辅助清除函数
  - 重写 `calculateShortestPath()`: 采用渐进式阈值匹配
  - 添加 `findNearestNode()`: 路网节点匹配辅助函数
  - 添加 `showSaveRouteDialog()`: 保存对话框
  - 添加 `saveRouteToDatabase()`: 保存路线逻辑
  - 添加 `showSavedRoutesPanel()`: 历史路线面板
  - 添加 `loadSavedRoute()`: 加载历史路线
  - 修改 `updateItineraryUI()`: 添加保存和历史按钮

---

## 三、集成步骤

### 步骤 1：执行数据库脚本

```powershell
# 在SQL Server Management Studio中执行
.\create_route_tables.sql
```

> **注意**：请先修改脚本中的数据库名 `USE [YourDatabaseName]`

### 步骤 2：确认代码文件已更新

所有代码已自动修改完成，无需手动操作：

- ✅ `Form1.Visual.cs` 已添加3个桥接方法
- ✅ `main.js` 已优化路径算法和UI

### 步骤 3：测试运行

1. 编译并运行应用程序
2. 进入"可视化演示"模式 → 点击"WEB"按钮
3. 点击左下角"路线规划"
4. 测试以下场景：

#### 测试A：视图切换刷新

- 规划一条路线后，切换到其他功能
- **预期**：地图应立即刷新，不显示之前的路线

#### 测试B：路径规划成功率

- 在济南和青岛之间规划路线（应100%成功）
- 在偏远地区规划路线（应显示友好错误提示）

#### 测试C：保存和加载路线

- 规划路线后点击"💾 保存此路线"
- 刷新页面后点击"📋 历史路线"
- 选择保存的路线，应自动重新计算路径

---

## 四、关键技术亮点

### 🔧 优化1：渐进式阈值匹配

原算法：固定阈值0.25度（25km），导致80%失败率

新算法：采用5级渐进阈值

```javascript
const MATCH_THRESHOLDS = [
    { threshold: 0.0001, name: '精确匹配 (~1km)' },
    { threshold: 0.0025, name: '近距离匹配 (~5km)' },
    { threshold: 0.0625, name: '中等距离匹配 (~25km)' },
    { threshold: 0.25, name: '远距离匹配 (~50km)' },
    { threshold: 1.0, name: '极远距离匹配 (~100km)' }
];
```

### 💡 优化2：按需计算路径（采纳用户建议）

**传统方案**：保存完整路径JSON到数据库

- ❌ 占用大量存储空间
- ❌ 路网更新后历史路线失效

**优化方案**：只保存起终点坐标

- ✅ 节省存储空间（约90%）
- ✅ 路径始终基于最新路网计算
- ✅ 加载逻辑简洁：`loadSavedRoute()` → `startPlanning()`

---

## 五、数据库表结构

### Saved_Routes（路线表）

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | INT | 主键 |
| RouteName | NVARCHAR(100) | 路线名称 |
| StartLng/StartLat | FLOAT | 起点坐标 |
| EndLng/EndLat | FLOAT | 终点坐标 |
| Description | NVARCHAR(500) | 描述 |
| CreatedDate | DATETIME | 创建时间 |

### Route_ICH_Items（非遗点位关联表）

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | INT | 主键 |
| RouteID | INT | 外键 → Saved_Routes.ID |
| ICH_Name | NVARCHAR(200) | 非遗名称 |
| SequenceOrder | INT | 顺序 |
| DistanceFromPath | FLOAT | 距离路径的距离 |

---

## 六、可能的问题与解决方案

### 问题1：数据库表已存在错误

**解决**：脚本已添加 `IF NOT EXISTS` 检查，可重复执行

### 问题2：路径规划仍失败

**排查步骤**：

1. 打开浏览器开发者工具（F12）→ Console
2. 查看是否有匹配成功的日志：`起点匹配成功: xxx`
3. 如果仍无法匹配，检查 `roads.json` 是否加载成功

### 问题3：保存路线按钮不显示

**原因**：WebView2桥接未初始化
**解决**：确认 `OpenWebVisualMode()` 中已正确设置 `window.bridge`

---

## 七、后续优化建议

1. **路径可视化增强**：在历史路线列表中显示缩略图
2. **路线分享功能**：生成分享链接或二维码
3. **智能推荐**：基于用户偏好自动推荐相似路线
4. **离线缓存**：将常用路线缓存到IndexedDB

---

## 八、注意事项

> [!WARNING]
> **数据库连接**：保存功能需要数据库连接，请确保 `DBHelper` 配置正确

> [!IMPORTANT]
> **路网数据**：路径规划功能依赖 `roads.json`，确保该文件在 `VisualWeb/data/` 目录下

---

**修改人**：[Member E]  
**审核人**：待审核  
**集成状态**：✅ 代码已提交，待测试验证
